(()=>{"use strict";const e="8105108896210480",n="6587188887985110",t="25608122958833765",r="7524441461015054",o="2225174527520692";async function l(e){var n;return(await(n=[e],new Promise((e=>chrome.storage.local.get(n,e)))))[e]}function a(e){return`https://internalfb.com/intern${e}`}const i="tool_consolidation",s=`${i}/cached_graphql/v2/`,u=`${i}/settings/csrftoken/v1`,c=a("/api/dtsg/internal");let d=null,w=null;function f(){const e=Date.now()/1e3;return(null===d||w<=e)&&(d=async function(){const e=await l(u),n=Date.now()/1e3+60;if(null!=e&&e.expire>=n)return e.token;const t=await fetch(c);if(200!==t.status)return console.warn(`Failed GraphQL fetch. Status Code: ${t.status}`),null;const r=await t.text();if(null==r)return console.warn("Failed to get CSRF token"),null;const o=JSON.parse(r.slice(9));return await async function(e,n){return t={[e]:n},new Promise((e=>chrome.storage.local.set(t,e)));var t}(u,o),o.token}(),w=e+7200),d}function h(e,n){return f().then((t=>{let r=a(`/api/graphql?doc_id=${e}`);return n&&(r+=`&variables=${encodeURIComponent(JSON.stringify(n))}`),r+=`&fb_dtsg=${t}&__a=1`,async function(e,n){return fetch(e,{method:"POST",body:void 0}).then((e=>{if(!e.ok)throw new Error("error");return e.body})).then((e=>{const n=e.getReader();return new ReadableStream({start(e){const t=()=>{n.read().then((({done:n,value:r})=>{n?e.close():(e.enqueue(r),t())}))};t()}})})).then((e=>new Response(e,{headers:{"Content-Type":"text/html"}}).text()))}(r)})).then((e=>{const n=JSON.parse(e);return n.error?(console.warn(`Failed GraphQL fetch. Status Code: ${n.error}`),null):null!=n?n.data:null}))}const m=["/all","/browse","/account"],p=0x54845a26d9bfe;function g(e){return new RegExp("^[A-Za-z]+://fb.quip.com/[A-Za-z0-9]+","gs").test(e)}function _(e){return new RegExp("^[A-Za-z]+://www.dropbox.com/s[cl|so]*[/\\?].+","gs").test(e)}async function b(n){return new Promise(((t,r)=>h(e,{name:n}).then((e=>{var n;return t(null==e||null===(n=e.knob)||void 0===n?void 0:n.result)})).catch((e=>r(new Error(e))))))}const y=604800;async function v(e,r){if(null==e.url)return null;const o=function(e,r){switch(r){case n:return new URL(e).pathname.split("/")[1];case t:return function(e){if(!_(e))return e;const n=e.match(/cont=([A-Za-z0-9-%_\.]+)&*/);return null!=n&&n.length>1?"https://www.dropbox.com"+decodeURIComponent(n[1]):e}(e);default:return null}}(e.url,r);return null==o||""===o||o.startsWith("-")?null:new Promise(((e,l)=>h(r,{id:o}).then((o=>{var l,a;switch(r){case n:e(null==o||null===(l=o.xfb_du_get_quip_asset_by_quip_id)||void 0===l?void 0:l.google_asset_link);break;case t:e(null==o||null===(a=o.fetch__XFBToolConsolidationDropbox2Google)||void 0===a?void 0:a.google_drive_link);break;default:e(null)}})).catch((e=>l(new Error(e))))))}async function x(e,n,t,o,l){null==t&&null==o||await async function(e,n,t,o=null,l=null){return new Promise(((a,i)=>h(r,{logger_input:{system_environment:n,event_type:t,system_type:e,extra_metadata:o,exception:l}}).then((e=>{const n=null==e?void 0:e.xfb_tc_log_event;null!=n&&i(new Error(n)),a(n)})).catch((e=>i(new Error(e))))))}(e,"PROD","REDIRECT",JSON.stringify({originalUrl:n,redirectUrl:t,...l}),null==o?null:{message:o,code:1})}async function R(e,n,t){let r=null;const a=n.url;let i=null,u=null;const c=function(e){const n=new URL(e);return n.search="",n.hash="",`https://www.internalfb.com/quip2google/redirect?url=${n.toString()}`}(t);try{if(!await b("ep_tool_consolidation/common:quip2google_redirection"))return;if(u=await async function(){return new Promise((e=>function(e,n,t,r){let o=s+e;const a=Math.floor(Date.now()/1e3);l(o).then((l=>{null!=l&&r(l.payload),(null==l||l.expiration<a)&&h(e,n).then((e=>{if(null==e)return;const n={payload:e,expiration:a+(t||86400)};chrome.storage.local.set({[o]:n}),r(e)}))}))}(o,null,y,(n=>{let t=null;try{t=n.viewer.account_user.intern_user.unencoded_id}catch(e){console.error(e)}finally{e(t)}}))))}(),null!=u&&(i=await async function(e,n){return new Promise(((e,t)=>h("7570658543040059",{id:p,user_id:n}).then((n=>{var t;e(null==n||null===(t=n.fetch__PermissionGroup)||void 0===t?void 0:t.is_member)})).catch((e=>{t(new Error(e))}))))}(0,u),i))return;chrome.tabs.update(e,{url:c})}catch(e){r=e.message}finally{await x("QUIP",a,c,r,{intern_user_id:u,amp_group_id:p,is_member:i})}}chrome.tabs.onUpdated.addListener((async(e,r)=>{const{url:o}=r;if(null!=o)if(g(o))if(function(e){return new RegExp("^[A-Za-z]+://fb.quip.com/account/login.+","gs").test(e)}(o)){let n=new URL(o).searchParams.get("next");if(null==n)return;await R(e,r,n)}else if(m.some((e=>null==o?void 0:o.includes(e))))await chrome.tabs.sendMessage(e,{url:null});else{const t=await v(r,n);await chrome.tabs.sendMessage(e,{url:t})}else if(function(e){return new RegExp("^[A-Za-z]+://www.internalfb.com/intern/saml/.+fb_quip_1.+","gs").test(e)}(o)){const n=await async function(){let e=(new Date).getTime()-6e4;const n=new Promise(((n,t)=>chrome.history.search({text:"fb.quip.com",startTime:e,maxResults:10},(e=>n(e))))),t=(await n).filter((e=>g(e.url)&&!m.some((n=>{var t;return null===(t=e.url)||void 0===t?void 0:t.includes(n)})))).sort(((e,n)=>n.lastVisitTime-e.lastVisitTime));return t.length>0?t[0].url:null}();if(null==n)return;await R(e,r,n)}else _(o)&&await async function(e,n){if(!await b("ep_tool_consolidation/common:dropbox2google_redirection"))return;let r=null;const o=n.url,l=await v(n,t);try{chrome.tabs.update(e,{url:l})}catch(e){r=e.message}finally{await x("DROPBOX",o,l,r,{})}}(e,r)})),chrome.webNavigation.onCompleted.addListener((e=>{let t=null,r=null;new Promise((async()=>{t=await v(e,n),[r]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0}),null!=r&&null!=r.id&&await chrome.tabs.sendMessage(r.id,{url:t})}))}),{url:[{hostContains:"fb.quip.com"}]}),chrome.webRequest.onBeforeRedirect.addListener((e=>{const n=e.url;g(n)&&chrome.history.addUrl({url:n})}),{urls:["<all_urls>"]},[])})();
//# sourceMappingURL=serviceWorker.js.map